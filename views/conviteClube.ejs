<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%- include('partials/favicon') %>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/conviteClube.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title><%= titulo %></title>
</head>
<body>
    <div class="convite-container">
        <div class="convite-card">
            <div class="convite-header">
                <div class="loom-logo">
                    <img src="/logo-192.png" alt="Loom" class="logo-img" onerror="this.src='/favicon-32x32.png'; this.style.width='32px'; this.style.height='32px'">
                    <h1>Loom</h1>
                </div>
                <h2>Convite para Clube de Leitura</h2>
            </div>
            
            <div class="clube-preview">
                <div class="clube-info">
                    <h3><%= clube.nome %></h3>
                    <p class="clube-descricao"><%= clube.descricao || 'Este clube não possui descrição.' %></p>
                    
                    <div class="clube-detalhes">
                        <div class="detalhe-item">
                            <i class="fas fa-user"></i>
                            <span>Criado por <%= clube.nome_criador %></span>
                        </div>
                        
                        <div class="detalhe-item">
                            <i class="fas fa-users"></i>
                            <span><%= clube.total_membros %> <%= clube.total_membros === 1 ? 'membro' : 'membros' %></span>
                        </div>
                        
                        <div class="detalhe-item">
                            <i class="fas <%= clube.visibilidade === 'publico' ? 'fa-globe' : 'fa-lock' %>"></i>
                            <span><%= clube.visibilidade === 'publico' ? 'Público' : 'Privado' %></span>
                        </div>
                        
                        <div class="detalhe-item">
                            <i class="fas fa-calendar"></i>
                            <span>Criado em <%= new Date(clube.data_criacao).toLocaleDateString('pt-BR') %></span>
                        </div>
                    </div>
                    
                    <% if (clube.categorias && clube.categorias.length > 0) { %>
                        <div class="clube-categorias">
                            <% clube.categorias.forEach(categoria => { %>
                                <span class="categoria-tag"><%= categoria %></span>
                            <% }) %>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <div class="convite-acoes">
                <% if (userId) { %>
                    <!-- Usuário logado -->
                    <button id="btn-entrar-clube" class="btn-principal" onclick="entrarNoClube()">
                        <i class="fas fa-sign-in-alt"></i> Entrar no Clube
                    </button>
                    

                    
                    <a href="/dashboard" class="btn-secundario">
                        <i class="fas fa-home"></i> Ir para Dashboard
                    </a>
                <% } else { %>
                    <!-- Usuário não logado -->
                    <p class="login-necessario">Para participar deste clube, você precisa estar logado.</p>
                    <a href="/autenticacao" class="btn-principal">
                        <i class="fas fa-sign-in-alt"></i> Entrar ou Criar Conta
                    </a>
                <% } %>
            </div>
        </div>
        
        <div class="convite-footer">
            <p>
                <img src="/logo-192.png" alt="Loom" class="footer-logo" onerror="this.src='/favicon-16x16.png'">
                Compartilhe sua paixão pela leitura no <strong>Loom</strong>
            </p>
        </div>
    </div>

    <% if (userId) { %>
    <script>
        const clubeId = <%= clube.id %>;
        const clubeVisibilidade = '<%= clube.visibilidade %>';
        const clubeNome = <%- JSON.stringify(clube.nome) %>;
        
        async function entrarNoClube() {
            console.log('Função entrarNoClube chamada');
            
            // Verificar se SweetAlert2 está disponível
            if (typeof Swal === 'undefined') {
                alert('Sistema de alertas não carregado. Recarregue a página.');
                return;
            }
            
            // Desabilitar botão e mostrar loading
            const btnEntrar = document.getElementById('btn-entrar-clube');
            const textoOriginal = btnEntrar.innerHTML;
            btnEntrar.disabled = true;
            btnEntrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            
            try {
                let senha = null;
                
                // Se clube é privado, pedir senha
                if (clubeVisibilidade === 'privado') {
                    const { value: senhaInput } = await Swal.fire({
                        title: 'Clube Privado',
                        text: 'Este clube é privado. Digite a senha para entrar:',
                        input: 'password',
                        inputPlaceholder: 'Digite a senha do clube',
                        showCancelButton: true,
                        confirmButtonText: 'Entrar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#6A5ACD',
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Você precisa digitar a senha!'
                            }
                        }
                    });
                    
                    if (!senhaInput) {
                        return; // Usuário cancelou
                    }
                    
                    senha = senhaInput;
                } else {
                    // Clube público, confirmar entrada
                    const resultado = await Swal.fire({
                        title: 'Entrar no Clube',
                        text: `Deseja entrar no clube "${clubeNome}"?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Sim, entrar!',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#6A5ACD'
                    });
                    
                    if (!resultado.isConfirmed) {
                        return; // Usuário cancelou
                    }
                }
                
                // Fazer requisição para entrar no clube
                console.log('Enviando requisição para entrar no clube');
                
                const response = await fetch('/api/convite-clube/entrar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ clubeId, senha })
                });
                
                let data;
                try {
                    const text = await response.text();
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('Erro ao fazer parse do JSON:', parseError, 'Resposta:', text);
                    throw new Error('Resposta inválida do servidor');
                }
                
                if (response.ok) {
                    await Swal.fire({
                        title: 'Sucesso!',
                        text: data.mensagem,
                        icon: 'success',
                        confirmButtonText: 'Ir para o Clube',
                        confirmButtonColor: '#6A5ACD'
                    });
                    
                    // Redirecionar para o clube
                    window.location.href = `/clube/${clubeId}`;
                } else {
                    // Tratar caso especial de usuário já participante
                    if (data.jaParticipa) {
                        await Swal.fire({
                            title: 'Você já é membro!',
                            text: data.erro,
                            icon: 'info',
                            confirmButtonText: 'Ir para o Clube',
                            confirmButtonColor: '#6A5ACD'
                        });
                        window.location.href = `/clube/${clubeId}`;
                        return;
                    }
                    
                    Swal.fire({
                        title: 'Erro',
                        text: data.erro || 'Erro desconhecido',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#6A5ACD'
                    });
                }
            } catch (error) {
                console.error('Erro ao entrar no clube:', error);
                Swal.fire({
                    title: 'Erro',
                    text: 'Erro ao conectar com o servidor. Tente novamente.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6A5ACD'
                });
            } finally {
                // Restaurar botão
                if (btnEntrar) {
                    btnEntrar.disabled = false;
                    btnEntrar.innerHTML = textoOriginal;
                }
            }
        }
        

        
    </script>
    <% } %>
</body>
</html>
