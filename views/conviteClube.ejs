<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%- include('partials/favicon') %>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/conviteClube.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title><%= titulo %></title>
</head>
<body>
    <div class="convite-container">
        <div class="convite-card">
            <div class="convite-header">
                <div class="loom-logo">
                    <img src="/logo-192.png" alt="Loom" class="logo-img" onerror="this.src='/favicon-32x32.png'; this.style.width='32px'; this.style.height='32px'">
                    <h1>Loom</h1>
                </div>
                <h2>Convite para Clube de Leitura</h2>
            </div>
            
            <div class="clube-preview">
                <div class="clube-info">
                    <h3><%= clube.nome %></h3>
                    <p class="clube-descricao"><%= clube.descricao || 'Este clube não possui descrição.' %></p>
                    
                    <div class="clube-detalhes">
                        <div class="detalhe-item">
                            <i class="fas fa-user"></i>
                            <span>Criado por <%= clube.nome_criador %></span>
                        </div>
                        
                        <div class="detalhe-item">
                            <i class="fas fa-users"></i>
                            <span><%= clube.total_membros %> <%= clube.total_membros === 1 ? 'membro' : 'membros' %></span>
                        </div>
                        
                        <div class="detalhe-item">
                            <i class="fas <%= clube.visibilidade === 'publico' ? 'fa-globe' : 'fa-lock' %>"></i>
                            <span><%= clube.visibilidade === 'publico' ? 'Público' : 'Privado' %></span>
                        </div>
                        
                        <div class="detalhe-item">
                            <i class="fas fa-calendar"></i>
                            <span>Criado em <%= new Date(clube.data_criacao).toLocaleDateString('pt-BR') %></span>
                        </div>
                    </div>
                    
                    <% if (clube.categorias && clube.categorias.length > 0) { %>
                        <div class="clube-categorias">
                            <% clube.categorias.forEach(categoria => { %>
                                <span class="categoria-tag"><%= categoria %></span>
                            <% }) %>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <div class="convite-acoes">
                <% if (userId) { %>
                    <!-- Usuário logado -->
                    <button id="btn-entrar-clube" class="btn-principal" onclick="entrarNoClube()">
                        <i class="fas fa-sign-in-alt"></i> Entrar no Clube
                    </button>
                    
                    <a href="/dashboard" class="btn-secundario">
                        <i class="fas fa-home"></i> Ir para Dashboard
                    </a>
                <% } else { %>
                    <!-- Usuário não logado -->
                    <p class="login-necessario">Para participar deste clube, você precisa estar logado.</p>
                    <a href="/autenticacao" class="btn-principal">
                        <i class="fas fa-sign-in-alt"></i> Entrar ou Criar Conta
                    </a>
                <% } %>
            </div>
        </div>
        
        <div class="convite-footer">
            <p>
                <img src="/logo-192.png" alt="Loom" class="footer-logo" onerror="this.src='/favicon-16x16.png'">
                Compartilhe sua paixão pela leitura no <strong>Loom</strong>
            </p>
        </div>
    </div>

    <!-- Modal Clube Privado -->
    <div class="overlay" id="overlay-privado" style="display: none;"></div>
    <div id="modal-clube-privado" style="display: none;">
        <div class="form-container">
            <h2>Clube Privado</h2>
            <p>Digite a senha para entrar no clube:</p>

            <form id="form-clube-privado">
                <div class="senha-input-container">
                    <input 
                        type="password" 
                        id="senhaClubePrivado" 
                        placeholder="Senha do clube" 
                        required>
                    <button type="button" class="toggle-senha" onclick="toggleSenhaPrivada()">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <p class="senha-info">A senha é definida pelo criador do clube.</p>

                <div class="form-buttons">
                    <button type="submit" id="confirmarClube" class="btn-principal">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                    <button type="button" id="cancelarClube" onclick="fecharModalPrivado()">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <% if (userId) { %>
    <script>
        const clubeId = <%= clube.id %>;
        const clubeVisibilidade = '<%= clube.visibilidade %>';
        const clubeNome = <%- JSON.stringify(clube.nome) %>;
        
        async function entrarNoClube() {
            if (clubeVisibilidade === 'privado') {
                abrirModalPrivado();
                return;
            }

            // Clube público -> confirmação
            const resultado = await Swal.fire({
                title: 'Entrar no Clube',
                text: `Deseja entrar no clube "${clubeNome}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sim, entrar!',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#6A5ACD'
            });
            
            if (!resultado.isConfirmed) return;
            
            await entrarNoClubeComSenha(null);
        }

        async function entrarNoClubeComSenha(senha) {
            const btnEntrar = document.getElementById('btn-entrar-clube');
            const textoOriginal = btnEntrar.innerHTML;
            btnEntrar.disabled = true;
            btnEntrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';

            try {
                const response = await fetch('/api/convite-clube/entrar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ clubeId, senha })
                });

                const data = await response.json();

                if (response.ok) {
                    window.location.href = `/clube/${clubeId}`;
                } else {
                    if (data.jaParticipa) {
                        Swal.fire('Você já é membro!', data.erro, 'info')
                            .then(() => window.location.href = `/clube/${clubeId}`);
                    } else {
                        Swal.fire('Erro', data.erro || 'Erro desconhecido', 'error');
                    }
                }
            } catch (error) {
                Swal.fire('Erro', 'Erro ao conectar com o servidor.', 'error');
            } finally {
                btnEntrar.disabled = false;
                btnEntrar.innerHTML = textoOriginal;
            }
        }

        // Modal privado
        function abrirModalPrivado() {
            document.getElementById("overlay-privado").style.display = "block";
            document.getElementById("modal-clube-privado").style.display = "flex";
        }

        function fecharModalPrivado() {
            document.getElementById("overlay-privado").style.display = "none";
            document.getElementById("modal-clube-privado").style.display = "none";
        }

        function toggleSenhaPrivada() {
            const input = document.getElementById("senhaClubePrivado");
            const icon = document.querySelector(".toggle-senha i");
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }

        document.getElementById("form-clube-privado")?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const senha = document.getElementById("senhaClubePrivado").value;
            fecharModalPrivado();
            await entrarNoClubeComSenha(senha);
        });
    </script>
    <% } %>
</body>
</html>
