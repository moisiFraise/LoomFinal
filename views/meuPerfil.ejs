<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-bust" content="<%= timestamp || Date.now() %>">
    <%- include('partials/favicon') %>
    <title>Loom - Meu Perfil</title>
    <link rel="stylesheet" href="/css/meuPerfil.css">
    <link rel="stylesheet" href="/css/menu.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/atualizacoes.css">
    <link rel="stylesheet" href="/css/emocoes-atualizacao.css">

</head>
<body>
    <%- include('partials/menu') %>
    <%- include('partials/imports') %>
    
    <div class="container">
        <div class="perfil-header">
            <div class="foto-perfil-container">
                <img src="<%= usuario.foto_perfil || '/uploads/perfil/default-profile.jpg' %>" alt="Foto de perfil" id="foto-perfil">
                <div class="editar-foto">
                    <label for="upload-foto">
                        <i class="fas fa-camera"></i>
                    </label>
                    <input type="file" id="upload-foto" name="fotoPerfil" accept="image/*" style="display: none;">
                </div>
        </div>
            <div class="info-perfil">
                <h1 id="nome-usuario"><%= usuario.nome %></h1>
                <p id="email-usuario"><%= usuario.email %></p>
                <button id="btn-editar-perfil" class="btn-editar">Editar Perfil</button>
            </div>
        </div>
        
        <div class="biografia-container">
            <h3>Biografia</h3>
            <p id="biografia-texto"><%= usuario.biografia || 'Adicione uma biografia para que outros usuários conheçam você melhor.' %></p>
        </div>
        
        <div class="estatisticas">
            <div class="estatistica">
                <span class="numero"><%= clubes.length -1 || 0 %></span>
                <span class="label">Clubes</span>
            </div>
            <div class="estatistica">
                <span class="numero"><%= publicacoes.length || 0 %></span>
                <span class="label">Publicações</span>
            </div>
        </div>
        
        <h2 class="publicacoes-titulo">Minhas Publicações</h2>
        <div class="filtro-publicacoes">
            <button class="btn-filtro ativo" data-filtro="todas">Todas</button>
            <button class="btn-filtro" data-filtro="publicas">Públicas</button>
            <button class="btn-filtro" data-filtro="privadas">Privadas</button>
        </div>
        
        <div class="lista-publicacoes">
            <% if (!publicacoes || publicacoes.length === 0) { %>
                <div class="sem-publicacoes">
                    <p>Você ainda não fez nenhuma publicação.</p>
                </div>
            <% } else { %>
                <% publicacoes.forEach(pub => { %>
                    <div class="atualizacao-item publicacao-item <%= pub.visibilidade %>" data-clube-id="<%= pub.id_clube %>" data-porcentagem="<%= pub.porcentagem_leitura || 0 %>" data-id="<%= pub.id %>">
                        <div class="atualizacao-header publicacao-header">
                         <span class="atualizacao-nome"><%= pub.nome %></span>
                            <div class="atualizacao-usuario-info">
                                <div class="usuario-avatar" title="<%= usuario.nome %>">
                                    <% if (usuario.foto_perfil) { %>
                                        <img src="<%= usuario.foto_perfil %>" alt="<%= usuario.nome %>" onerror="this.parentElement.innerHTML='<div class=\\'usuario-avatar-placeholder\\'><%= usuario.nome.charAt(0).toUpperCase() %></div>'">
                                    <% } else { %>
                                        <div class="usuario-avatar-placeholder"><%= usuario.nome.charAt(0).toUpperCase() %></div>
                                    <% } %>
                                </div>
                                <div class="atualizacao-usuario-data">
                                    <span class="atualizacao-usuario">
                                        <%= usuario.nome %>
                                        <% if (pub.emocao_emoji) { %>
                                            <span class="atualizacao-emocao" style="background-color: <%= pub.emocao_cor %>"><%= pub.emocao_emoji %> <%= pub.emocao_nome %></span>
                                        <% } %>
                                    </span>
                                    <span class="atualizacao-data"><%= new Date(pub.data_postagem).toLocaleDateString('pt-BR') %> às <%= new Date(pub.data_postagem).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) %></span>
                                </div>
                            </div>
                            <div class="clube-info">
                                <% if (pub.visibilidade === 'privado') { %>
                                    <span class="clube-nome">Publicação Privada</span>
                                    <span class="clube-privado"><i class="fas fa-lock"></i></span>
                                <% } else { %>
                                    <span class="clube-nome"><%= pub.nome_clube %></span>
                                    <span class="clube-publico"><i class="fas fa-globe"></i></span>
                                <% } %>
                            </div>
                        </div>
                        <div class="atualizacao-conteudo publicacao-conteudo">
                            <p><%= pub.conteudo %></p>
                        </div>
                        <% if (pub.gif_url) { %>
                            <div class="gif-container">
                                <img src="<%= pub.gif_url %>" alt="GIF" loading="lazy">
                            </div>
                        <% } %>
                        <div class="atualizacao-footer publicacao-footer">
                            <div class="atualizacao-progresso progresso-leitura">
                                <div class="progresso-barra-container barra-progresso">
                                    <div class="progresso-barra progresso" style="width: <%= pub.porcentagem_leitura || 0 %>%;"></div>
                                </div>
                                <span class="progresso-texto porcentagem"><%= pub.porcentagem_leitura || 0 %>% concluído</span>
                            </div>
                            <div class="atualizacao-interacoes acoes-publicacao">
                                <button class="botao-curtir" data-id="<%= pub.id %>" onclick="alternarCurtida(<%= pub.id %>)">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <span class="contador-curtidas" data-id="<%= pub.id %>">0</span>
                                <button class="botao-comentar" onclick="comentariosManager.toggleComentarios(<%= pub.id %>, 'comentarios-<%= pub.id %>', <%= userId %>)">
                                    <i class="far fa-comment"></i>
                                    <span class="comentarios-count" data-atualizacao-id="<%= pub.id %>">0</span>
                                </button>
                                <% if (pub.id_usuario === userId) { %>
                                    <button class="btn-editar-publicacao" data-id="<%= pub.id %>" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-excluir-publicacao" data-id="<%= pub.id %>" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                <% } %>
                            </div>
                        </div>
                        <div class="comentarios-container" id="comentarios-<%= pub.id %>" style="display: none;"></div>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </div>
    
    <!-- Modal de Edição de Perfil -->
    <div id="modal-editar-perfil" class="modal">
        <div class="modal-conteudo">
            <span class="fechar-modal">&times;</span>
            <h2>Editar Perfil</h2>
            <form id="form-editar-perfil">
                <div class="form-grupo">
                    <label for="editar-nome">Nome</label>
                    <input type="text" id="editar-nome" value="<%= usuario.nome %>" required>
                </div>
                <div class="form-grupo">
                    <label for="editar-email">Email</label>
                    <input type="email" id="editar-email" value="<%= usuario.email %>" required>
                </div>
                <div class="form-grupo">
                    <label for="editar-biografia">Biografia</label>
                    <textarea id="editar-biografia" rows="4"><%= usuario.biografia || '' %></textarea>
                </div>
                <div class="form-grupo">
                    <label for="editar-senha">Nova Senha (deixe em branco para manter a atual)</label>
                    <input type="password" id="editar-senha">
                </div>
                <div class="form-grupo">
                    <label for="confirmar-senha">Confirmar Nova Senha</label>
                    <input type="password" id="confirmar-senha">
                </div>
                <div class="acoes-form">
                    <button type="submit" class="btn-salvar">Salvar Alterações</button>
                    <button type="button" id="btn-excluir-conta" class="btn-excluir">Excluir Conta</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-confirmar-exclusao" class="modal">
        <div class="modal-conteudo">
            <span class="fechar-modal">&times;</span>
            <h2>Confirmar Exclusão</h2>
            <p>Tem certeza que deseja excluir sua conta? Esta ação não pode ser desfeita.</p>
            <div class="acoes-form">
                <button id="btn-confirmar-exclusao" class="btn-excluir">Sim, Excluir Minha Conta</button>
                <button id="btn-cancelar-exclusao" class="btn-cancelar">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div class="notificacao" style="display: none;"></div>
    
    <!-- SCRIPT NUCLEAR DE LIMPEZA -->
    <script src="/js/nuclear-cleanup.js"></script>
    
    <script>
        // Definir userId para uso em JavaScript  
        const userId = <%= typeof userId !== "undefined" && userId ? userId : 'null' %>;
        const currentTimestamp = '<%= timestamp || Date.now() %>';
        const sessionId = '<%= sessionId || "" %>';
        
        console.log('userId definido para meuPerfil:', userId);
        console.log('timestamp da página:', currentTimestamp);
        console.log('sessionId:', sessionId);
        
        // Forçar reload se os dados parecem estar em cache
        if (performance && performance.navigation && performance.navigation.type === 2) {
            console.log('Página carregada do cache, forçando reload...');
            window.location.reload(true);
        }
        
        // Função para recarregar dados do perfil
        window.recarregarPerfil = function() {
            window.location.href = '/meuPerfil?refresh=' + Date.now();
        };
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.publicacao-item').forEach(item => {
    const progressBar = item.querySelector('.progresso');
    const percentageText = item.querySelector('.porcentagem');
    
    try {
      const percentage = parseInt(item.getAttribute('data-porcentagem') || '0');
      const safePercentage = isNaN(percentage) ? 0 : Math.max(0, Math.min(100, percentage));
      
      progressBar.style.width = safePercentage + '%';
      percentageText.textContent = safePercentage + '% concluído';
    } catch (e) {
      console.error('Error setting progress bar:', e);
      progressBar.style.width = '0%';
      percentageText.textContent = '0% concluído';
    }
  });
});
</script>
    <script src="/js/meuPerfil.js"></script>
    <script src="/js/curtidas.js"></script>
    <script src="/js/comentarios.js"></script>
</body>
</html>
